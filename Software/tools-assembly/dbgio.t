** very simple serial IO program, to access the* debug environment in IOP or GPP monitor ROM** it connects to that via /dev/dbgioX* if the board is absent or the ROM does not support* debug IO, no harm is to be done*        lib     sysdef        lib     sysints***start   ldd     0,s             get arg count        cmpd    #2              should be 2        lbne    err1        ldx     4,s             point to arg1        ldd     0,x        sta     dfilnam         name modifier*        sys     open,dfile,2    open the debug serial connection        lbcs     err1        std     dfd             keep file reference        ldd     #0        sys     gtty,portorg    save original console settings        ldd     #0        sys     gtty,portstat   and modify        lda     #%01100011      single char, raw, etc        sta     portstat        ldd     #1        sys     stty,portstat   change the console settings*        ldd     dfd             send trigger        sys     write,rcmd,1** main loop*st004   ldd     #0              check if a console char was typed        sys     gtty,portstat        bcs     err1        lda     portsta+4       data available?        bpl     st002*        ldd     #0              there is data        sys     read,buffer,1   no we can read        bcs     err1*        lda     buffer          is it the 'break' character?        cmpa     #$1c           ^\        bne     st005* make it easy to open next time        ldd     dfd        sys     write,nulbyt,1*        ldd     #0              if so, we restore the console        sys     stty,portorg    settings and bail out        ldd     #0        sys     term*st005   ldd     dfd             else, we put the character to        sys     write,buffer,1  the debug ROM        bcs     err2*st002   ldd     dfd             (try to) read a character from        sys     read,buffer,1   the debug ROM        bcs     err2*        lda     buffer          if char is null, nothing present        beq     st003        ldd     #1              else, output it to console        sys     write,buffer,1        bcs     err2        bra     st002           try for the next character*st003   sys     cpint,ALRMI,dowait  no data present,        ldd     #1        sys     alarm           sleep for a while.        sys     stop            wait for the alarm interrupt        bra     st004           main loop*dowait  rti                     just return*err1    ldd     #2              error at opening        sys     write,porter,portl1errx    ldd     #1        sys     term*err2    ldd     #2              error at data        sys     write,dataer,datal1        bra     errx*porter  fcc     "can't open port",$d,$a,0portl1  equ     *-porterdataer  fcc     "can read data",$d,$a,0datal1  equ     *-dataer*dfile   fcc     "/dev/dbgio"dfilnam fcb     '0,0            default name, will be overwrittennulbyt  fcb     0,0             empty stringrcmd    fcb     'R,0*portorg  rmb    6               original settingsportstat rmb    6               modified settingsdfd     rzb     2               file referencebuffer  rzb     2               tiny data buffer*        end     start