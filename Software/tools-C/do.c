#include <stdio.h>#include <signal.h>#include <stat.h>#define BINSH "/bin/shell"#define SH "shell"char    *pathnames[]={        "%s",        "./bin/%s",        "/etc/%s",        "/bin/%s",        "/usr/bin/%s",        "" };char    **path = pathnames;char    scriptname[25];char    linebuffer[80];char    *instr();int     intflag = 0;int     verbose = 0;FILE    *infp, *fopen();struct  stat    statbuf;extern  inthandler();main(argc, argv)int     argc;char    *argv[];{        if (argc != 2) {                fprintf(stderr, "usage: %s shell_script\n", argv[0]);                exit(1);        }        while (**path != 0) {                if (strncmp("/etc", *path, 4) == 0 && getuid() != 0)                        path++;                sprintf(scriptname, *path, argv[1]);                if (stat(scriptname, &statbuf) == 0)                        break;                path++;        }        if (**path == 0) {                fprintf(stderr, "%s: %s not found.\n", argv[0], argv[1]);                exit(1);        }        if ((infp = fopen(scriptname, "r"))) {                while (instr(linebuffer, 80, infp)) {                        if (verbose) {                                fputs("-- ", stdout);                                puts(linebuffer);                        }                        if (strncmp("verbose", linebuffer, 7) == 0) {                                verbose = 1;                                continue;                        }                        if (execute(linebuffer) != 0)                                if (askoptions() == -1) /* exit ? */                                        break;                }                fclose(infp);        }}askoptions(){        char    c;        int     value = 0;        do {                fprintf(stderr,                         "error, proceed (p), rewind (r) or exit (e) ? ");                instr(linebuffer, 2, stdin);                c = *linebuffer;        } while (c != 'p' && c != 'r' && c != 'e');        switch (c) {        case 'p':                break;        case 'r':                rewind(infp);                break;        case 'e':                value = -1;                break;        }        return value;}execute(s)char    *s;{#define CHILD 0        int     wp, pid, exit_stat=1;        fflush(stdout);        if ((pid = fork()) == CHILD) {                if (verbose)                        execl(BINSH,SH,"+cv",s,0);                else                        execl(BINSH,SH,"+c",s,0);       /* c=process as cmd*/                exit(1);        }         signal(SIGINT, SIG_IGN);        while ((wp = wait(&exit_stat)) != -1 && wp != pid);        signal(SIGINT, inthandler);        return exit_stat;}char *instr(buffer, maxlen, fp)char    *buffer;int     maxlen;FILE    *fp;{        char *val, *fgets();        val = fgets(buffer, maxlen, fp);         if (val) {                while (*buffer != '\n' && (buffer - val) < maxlen)                        buffer++;                *buffer = 0;        }        return (val);}inthandler(){        signal(SIGINT, inthandler);        intflag = 1;}