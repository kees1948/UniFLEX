/* *  getenv(name) *  returns ptr to value associated with name, if any, else NULL * * we EMULATE an environment with a FILE which contains the enviroment * data. This file '.ENVIRON' can be in the current directory and/or * in the user home directory * The .ENVIRON file should be owned by the 'user' and should have * -rw-----  permissions at most.  -r------ is the minimum however * * first .ENVIRON is looked for in the current directory. but it should * meet the requirements or NULL is returned * */#include <stdio.h>#include <pwd.h>#include <stat.h>#include <modes.h>#define ENVNAME ".ENVIRON"#define ENVMODE 003         /* owner read-write */#define MAXHOMEPATH 61      /* 4 nested folders + '/' */#define NULL    0extern  char **environ;char    *nvmatch();char *getenv(name)register char *name;{   register char *v;   struct passwd *getpwuid();   struct passwd *pwptr;   struct stat estat;   int uid;   FILE *efd;   char enbuf[MAXHOMEPATH+14];   char *p;   uid = getuid();   if ((pwptr = getpwuid(uid)) == NULL)        return (NULL);                         /* unknown user ?? */   strcpy(enbuf, ENVNAME);                      /* in the current directory */   if ((stat(enbuf, &estat) != 0) || (estat.st_uid !=  uid))   {       if (strlen(pwptr->pw_dir) > MAXHOMEPATH)           return (NULL);       strcpy (enbuf, pwptr->pw_dir);       strcat (enbuf, "/");                     /* make sure at least one slash */       strcat (enbuf, ENVNAME);       if (stat(enbuf, &estat) != 0)            return (NULL);   }   if(estat.st_uid !=  uid)        return (NULL);                          /* it is not yours */   if ((estat.st_mode & S_IFMT) != S_IFREG)        return (NULL);                          /* it is not a regular file */   if((estat.st_mode & S_IPRM) != (S_IREAD|S_IWRITE))        return (NULL);                          /* it doesn't have the right permissions */    if((efd = fopen (enbuf, "r")) == NULL)        return (NULL);                          /* can't open it */    do    {        if(fgets (enbuf, 256, efd) == NULL)        {            fclose(efd);            return (NULL);        }        p = enbuf;        if ((v = nvmatch(name, p)) != NULL)        {            fclose(efd);            return(v);        }    }while(1);}/* *  s1 is either name, or name=value *  s2 is name=value *  if names match, return value of s2, else NULL *  used for environment searching: see getenv */static char *nvmatch(s1, s2)register char *s1, *s2;{    while (*s1 == *s2++)        if (*s1++ == '=')            return(s2);    if (*s1 == '\0' && *(s2-1) == '=')        return(s2);    return(NULL);}