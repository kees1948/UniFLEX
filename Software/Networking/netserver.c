#include <stdio.h>#include <net.h>#include <signal.h>#include <getopt.h>#include <modes.h>#define NBRQLN  4#define NBSIZE  4+512#define READBIT 0x10#define BUSYBIT 0x01#define SERVERIP  "0.0.0.0"struct netblock {unsigned char flags;unsigned char blhhh;unsigned char blmmm;unsigned char bllll;unsigned char payload [512];} NB;void usage();int pid;int main(argc, argv)int argc;char **argv;{    int sfdn, dfdn, i=0, dcount =0, clientlen;    struct sockaddr_in server;    struct sockaddr_in client;    int count = 0, c;    long offset;    char *p_opt = NULL;    char *f_opt = NULL;    int v_opt = 0, a_opt = 0;    char *nbp;    while((c = getopt(argc, argv, "vap:f:?")) != -1)    {        switch (c)        {                case 'p':                        p_opt = optarg;                        break;                case 'f':                        f_opt = optarg;                        break;                case 'v':                        v_opt = 1;                        break;                case 'a':                        a_opt = 1;                        break;                case '?':                        usage();        }    }/* verify that both options are set */    if ((p_opt == NULL)||(f_opt == NULL))    {        usage();    }/* open the disk image file */    if ((dfdn = open (f_opt, O_RDWR)) < 0)    {        fprintf(stderr, "Can't open block device file\n");        exit(-1);    }/* wait for connections here */    while(1)    {        if ((pid = fork()) == 0)        /* child */        {/* open listening socket */            if ((sfdn = socket(AF_INET, SOCK_STREAM|SOCK_SIGPIPECLS,0)) < 0)            {                break;            }            bzero(&server, sizeof(struct server));/* set it up */            server.sin_family = AF_INET;            server.sin_port = atoi (p_opt);            server.sin_addr = (uint32_t) inet_addr(SERVERIP) ;            i = bind(sfdn,(struct sockaddrin*) &server, sizeof(server));            if (i == -1)            {                printf ("Bind error!\n");                break;            }/* listen for incomaing connections */            listen(sfdn,1);            accept(sfdn,(struct sockaddr_in*)&client, &clientlen);/* main loop here, connection has been opened */            while(1)            {                if((count = read (sfdn, (char*)&NB.flags, sizeof(NB))) == 0)                {/* EOF, connection closed */                    close (sfdn);  /* eof */                    close (dfdn);                    exit(0);                }                nbp = &NB.flags;  /* set pointer *//* basic check, should pass */                if ((NB.flags & BUSYBIT) != BUSYBIT)                    abort();                if (v_opt == 1)                    fprintf(stderr,"read net %d bytes\n", count);                if ((count != NBRQLN) && (count != NBSIZE))                {/* the whole data set may come in chunks, collect the whole */                    if((count += read(sfdn, (char*)(nbp +count), NBSIZE-count)) != NBSIZE)                    {                        fprintf(stderr, "Invalid packet format received, aborting! \n");                        break;                    }                }/* calculate file offset */                offset =  ((long)                ( ((unsigned long) NB.blhhh << 16)                + ((unsigned long) NB.blmmm << 8)                + ((unsigned long) NB.bllll) ) * (unsigned long) BUFSIZ);                lseek (dfdn, (long) offset, 0);/* do we READ or WRITE? */                if ((NB.flags & READBIT) == 0)                { /*write */                if (v_opt == 1)/* tell me */       fprintf(stderr,"write image %3d bytes, flags: %02x\n", count, NB.flags);                if (a_opt == 1)                    fprintf(stderr,"diskaddress (hex) %02xx%02x%02x\n", NB.blhhh, NB.blmmm, NB.bllll);/* read remainder, first BUFSIZ has already been read */                    count += read (sfdn, (char*)(nbp + count), NBSIZE-count);                    write (dfdn, (char*) &NB.payload[0], BUFSIZ);                }                else                { /* read */                    if (v_opt == 1)                        fprintf(stderr,"read image %3d bytes, flags: %02x\n", count, NB.flags);                    if (a_opt == 1)                        fprintf(stderr,"diskaddress (hex) %02xx%02x%02x\n", NB.blhhh, NB.blmmm, NB.bllll);                    read ( dfdn, (char*) &NB.payload[0], BUFSIZ);/* our socket interface can do at most BUFSIZ bytes per transfer */                    count = write ( sfdn, (char*) &NB.flags, BUFSIZ);/* so we have to do an extra fetch for ALL data */                    count += write(sfdn, (char*) (nbp+count), NBSIZE - count);                }            }        }        else        { /* parent */            while(wait() != pid);            close (sfdn);        }    }    close (dfdn);}void usage(){    fprintf(stderr, "netserver -p <portno> -f <block_device_file>\n");    exit(1);}