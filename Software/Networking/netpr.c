#include <stdio.h>#include <net.h>#include <signal.h>#include <getopt.h>#include <modes.h>#include <errno.h>#define READBIT 0x10#define BUSYBIT 0x01/* default values, change for your situation */#define SERVERIP  "192.168.1.150"#define SERVERPORT  "32180"#define PRINTER   "/dev/npr1"char dbuf[BUFSIZ];extern int errno;void usage();int sfdn, dfdn;int pid;int main(argc, argv)int argc;char **argv;{    int i=0, dcount =0, clientlen;    struct sockaddr_in server;    struct sockaddr_in client;    char *phold = SERVERPORT;    char *dhold = PRINTER;    int count = 0, c;    long offset;    char *p_opt = NULL;    char *d_opt = NULL;    int v_opt = 0, l_opt = 0;    char *nbp;    while((c = getopt(argc, argv, "vlp:d:?")) != -1)    {        switch (c)        {                case 'p':                        p_opt = optarg;                        break;                case 'd':                        d_opt = optarg;                        break;                case 'v':                        v_opt = 1;                        break;                case 'l':                        l_opt = 1;                        break;                case '?':                        usage();        }    }/* verify that both options are set */    if (d_opt == NULL)    {        d_opt = dhold;    }    if (p_opt == NULL)    {        p_opt = phold;    }/* try to create the device */    if((dfdn == mknod( d_opt, (S_IFPIPE | S_IREAD | S_IWRITE), 0)) != 0)    {        if (dfdn != EEXIST)        {            fprintf(stderr,"  makeing pipe %d\n", dfdn);            return(1);        }    }/* setup server details */    bzero(&server, sizeof(struct server));    /* set it up */    server.sin_family = AF_INET;    server.sin_port = atoi (p_opt);    server.sin_addr = (uint32_t) inet_addr(SERVERIP) ;    /* *** main loop *** */    while(1)    {        if ((pid = fork()) == 0)        /* child */        {            /* open data pipe, spooler will write into it */            errno = 0;            if ((dfdn = open (d_opt, O_RDONLY)) < 0)            {                if (l_opt == 1)                    fprintf(stderr, "Can't open pipe device file %d\n", errno);                exit(-1);            }            /* wait for server to connect */            do            {               /* open socket */               if ((sfdn = socket(AF_INET, SOCK_STREAM|SOCK_SIGPIPECLS,0)) < 0)               {                   if (l_opt == 1)                       fprintf(stderr,"socket open fail!\n");                   exit(-1);               }                errno = 0;                i = connect(sfdn,(struct sockaddrin*) &server, sizeof(server));                if (i == 0)                    break;                close (sfdn);                if (l_opt == 1)                   fprintf(stderr,"connect result %d\n", errno);                sleep(2);            }while(1);            /* main data loop here */            while(1)            {                if((count = read (dfdn, dbuf, BUFSIZ)) == 0)                {                    if (v_opt == 1)                        fprintf(stderr,"EOF, close all\n");                    /* EOF, connection closed */                    close (sfdn);  /* eof */                    close (dfdn);                    return(0);                }                if (v_opt == 1)                    fprintf(stderr,"read pipe %d bytes\n", count);                write(sfdn, dbuf, count);            }        }        else        { /* parent */            signal(SIGPIPE, SIG_IGN);            while((wait()) != pid);            if (v_opt == 1)                fprintf(stderr,"new process\n");        }    }    if (l_opt = 1)        fprintf(stderr,"net print aborted, last job may be lost!!\n");    return(-1);}void usage(){    fprintf(stderr, "netpr -p <portno> -d <device> -v -l\n");    exit(1);}