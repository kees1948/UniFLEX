#include <stdio.h>#include <modes.h>#include <net.h>#include <getopt.h>struct nwset{unsigned int  nw_fam;         long nw_ip;unsigned int  nw_port;} ;struct netty {int   dummy1;struct nwset *tp;int   dummy2;} ;struct report {unsigned char ip1;unsigned char ip2;unsigned char ip3;unsigned char ip4;unsigned int  rport;};struct nwset NWS;struct netty NTTY;struct report RPRT;void usage();int main(argc, argv)int argc;char **argv;{    int dfdn, i=0;    int count = 0, c;    char *int_net_dev = NULL;    char *d_opt = NULL;    char *i_opt = NULL;    char* p_opt = NULL;    int v_opt = 0, r_opt = 0;    while((c = getopt(argc, argv, "d:i:p:v?")) != -1)    {        switch (c)        {                case 'p':                        p_opt = optarg;                        break;                case 'd':                        d_opt = optarg;                        break;                case 'v':                        v_opt = 1;                        break;                case 'i':                        i_opt = optarg;                        break;                case '?':                        usage();        }    }/* verify that all string options are set */    if((d_opt != NULL)&&(p_opt == NULL)&&(i_opt == NULL))    {        r_opt =1 ;    }    else    if ( ((p_opt == NULL)||(d_opt == NULL)||(i_opt==NULL)) && (r_opt == 0) )    {        usage();    }/* find the corresponding character device name */    if ((strcmp (d_opt,"netblk0")) == 0)    {        int_net_dev = "/dev/netblkc0";    }    else if ((strcmp (d_opt,"netblk1")) == 0)    {        int_net_dev = "/dev/netblkc1";    }    else    {        fprintf(stderr, "*** unknown network device!\n");        exit(-1);    }    if((dfdn = open ( int_net_dev, O_RDWR)) < 0)    {        fprintf(stderr, "*** can't open network device!\n");        exit (-1);    }    NTTY.tp = (char*)&NWS.nw_fam;    if (r_opt == 0)    {        errno = 0;        NWS.nw_fam = AF_INET;        NWS.nw_port = atoi(p_opt);        NWS.nw_ip   = inet_addr(i_opt);        if (errno)        {            fprintf(stderr, "*** error in IP address format!!\n");            exit(1);        }        if (( stty (dfdn, (char*)&NTTY)) < 0)        {            fprintf(stderr, "*** error, device is busy!\n");        }    }    gtty (dfdn, (char*)&RPRT);    printf("%s: %d.%d.%d.%d  %d\n", d_opt, RPRT.ip1,                                           RPRT.ip2,                                           RPRT.ip3,                                           RPRT.ip4,                                           RPRT.rport);}void usage(){    fprintf(stderr, "setnbdev -d <netblkX> [-p <portno> -i <ip_address>]\n");    exit(1);}