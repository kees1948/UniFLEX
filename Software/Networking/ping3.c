#include <stdio.h>#include <stdint.h>#include <net.h>#include <signal.h>#include <setjmp.h>#define BUF_LEN      56#define PING_REQUEST 8#define PING_REPLY   0#define CODE_ZERO    0struct PING {uint8_t type;uint8_t code;int16_t chksum;int16_t pingid;int16_t pseq;uint8_t data[BUF_LEN];} myping;struct RBUF{struct PING recvping;char    dummy[128];     /* slack */} rbuf;/* uint16_t checksum(data_buf, len);    */int usage();int rserverlen;timehnd();jmp_buf again;int main(argc, argv)int argc;char **argv;{    int sfdn, i=0, count =0, c;    struct sockaddr_in server, rserver;    uint32_t myaddr;    uint16_t rchecksum;    jmp_buf missed;    pflinit();    if (argc == 1)        usage();    signal(SIGALRM, timehnd);    sfdn = socket(AF_INET, SOCK_IPRAW,PROT_ICMP);    bzero(&server, sizeof(struct server));    server.sin_family = AF_INET;    server.sin_port = htons(3000);/* resolve name OR IP address */    if(        ((server.sin_addr = (uint32_t)inet_addr(argv[1])) == -1L)        &&        ((server.sin_addr = (uint32_t)getIPbyname(argv[1])) == -1L)      )    {                fprintf(stderr,"** unknown host \n");                exit(-1);    }    bzero(&myping, sizeof(struct PING));    myping.type = PING_REQUEST;    myping.code = CODE_ZERO;    myping.chksum = 0;    myping.pingid = getpid();    for (i =0; i < BUF_LEN; i++)    {        myping.data[i] = i % 8;    }    fprintf(stdout,"PING %u.%u.%u.%u 64 bytes of data\n",                (uint8_t)(server.sin_addr >>24 & 0xff),                (uint8_t)(server.sin_addr >>16 & 0xff),                (uint8_t)(server.sin_addr >>8  & 0xff),                (uint8_t)(server.sin_addr &0xff)                );    fflush(stdout);    while (1)    {        if (setjmp (again) == 1)        {            fprintf(stderr,"From %u.%u.%u.%u icmp_seq=%d Destination Host Unreachable\n",                (uint8_t)(server.sin_addr >>24 & 0xff),                (uint8_t)(server.sin_addr >>16 & 0xff),                (uint8_t)(server.sin_addr >>8  & 0xff),                (uint8_t)(server.sin_addr &0xff),                count                );        }        count++;        myping.chksum = 0;        myping.pseq = count;        myping.chksum = checksum ((char*)&myping, sizeof(myping));        i = sendto(sfdn, &myping, sizeof(struct PING), (struct sockaddrin*) &server, sizeof(server));        alarm(2);        if (i == -1)        {            printf ("Sending ping failed!\n");            exit(1);        }        i = recvfrom(sfdn, (char*)&rbuf, sizeof(rbuf), (struct sockaddrin*) &rserver, &rserverlen);        if (i == -1)        {            printf ("Receiving ping failed!\n");            exit(1);        }        rchecksum = checksum ((char*)&rbuf.recvping,sizeof(struct myping));        alarm(0);        if ((rbuf.recvping.type != PING_REPLY) || (rchecksum != 0xffff))        {            fprintf(stderr,"*** (invalid) reply received for seq %d\n chksm %04x",myping.pseq, rchecksum);        }        if (server.sin_addr != rserver.sin_addr)        {                continue;        }        else        {            fprintf(stdout,"%d bytes from %u.%u.%u.%u: icmp_seq=%d ttl=128\n",                i,                (uint8_t)nothl((rserver.sin_addr >> 24 & 0xff)),                (uint8_t)nothl((rserver.sin_addr >> 16 & 0xff)),                (uint8_t)nothl((rserver.sin_addr >> 8  & 0xff)),                (uint8_t)nothl((rserver.sin_addr & 0xff)),                rbuf.recvping.pseq                );        }        fflush(stdout);        fflush(stderr);        sleep(1);     }}int usage(){        fprintf(stderr, "usage:  ping server-IP \n");        exit(1);}timehnd(){   signal (SIGALRM, timehnd);   longjmp(again, 1);}