#include <stdio.h>#include <modes.h>#include <stdint.h>#include <getopt.h>#include <net.h>#define WZSKFILE "/dev/smem"#define WZSKBASE 0xe800L#define WZP2SOCK 0x0018#define WZP2DEV  0x001a#define S_SKCLS 0x00#define S_SINIT 0x13#define S_SLIST 0x14#define S_SESTB 0x17#define S_CLSWT 0x1c#define S_SKUDP 0x22#define S_SYNTX 0x15#define S_SYNRX 0x16#define S_FINWT 0x18#define S_ISCLS 0x1a#define S_TIMWT 0x1b#define S_LSTAC 0x1d#define S_SIRAW 0x32struct WZSK {uint8_t wzenum;uint8_t wzdctr;uint8_t wzfsta;uint8_t wzflg;/* W5500 register copy */uint8_t wzcmnd;uint8_t wzstat;uint8_t wzprio;uint8_t wzerr;/* data transfer info */uint16_t wzxfer;uint16_t wzrqln;uint16_t wzdma1;uint16_t wzdma2;/* networking info */uint16_t wzsprt;uint16_t wzdprt;uint32_t wzipad;uint16_t wzsflg;/* UDP info */uint32_t wzuipa;uint16_t wzuprt;uint16_t wzurms;uint16_t wzuwrp;/* open parameters */uint16_t wzfaml;uint16_t wztype;uint16_t wzprot;} wzsock;struct WZSK allsock[8];struct NWDEV {uint32_t wzmyip;uint16_t wzsbnm;uint16_t wzgwad;uint8_t  wzhwad[6];uint8_t  wzdsta;uint8_t  dummy[3];} wznwdev;union L2B{uint32_t ll;uint8_t  lc[4];} l2b;char formatbuf[128];showsocket(cnt, sptr);char *stat2str(stat_byte);#define POS1  25#define POS2  50int main(argc, argv)int argc;char **argv;{        int mfdn = -1, i, j, ci;        uint16_t offset;        uint8_t c;        int t_opt = 0, u_opt=0, r_opt=0;        while ((ci = getopt(argc, argv, "atuw?")) != -1)        {                switch(ci)                {                        case 't':                                t_opt = 1;                                break;                        case 'u':                                u_opt = 1;                                break;                        case 'w':                                r_opt = 1;                                break;                        case 'a':                                t_opt = u_opt = r_opt = 1;                                break;                        default:                                t_opt = u_opt = r_opt = 0;                }        }        if((mfdn = open(WZSKFILE, O_RDONLY)) < 0)        {                fprintf(stderr,"*** Can't open device info!\n");                exit (1);        }/* read pointer value */        lseek(mfdn, (long) WZSKBASE, 0);        lseek(mfdn, (long) WZP2SOCK, 1);        read(mfdn, (char*)&c, 1);        offset = c << 8;        read(mfdn, (char*)&c, 1);        offset +=c;/* seek to socket base + pointer */        lseek(mfdn, (long) WZSKBASE,0);        lseek(mfdn, (long) offset, 1);/* read all sockets at once */        if ( (i = read(mfdn, (char*)&allsock[0], sizeof(allsock)) ) !=                sizeof(allsock))        {                fprintf(stderr,"*** error reading socket info!\n");                exit(2);        }/* read pointer value */        lseek(mfdn, (long) WZSKBASE, 0);        lseek(mfdn, (long) WZP2DEV, 1);        read(mfdn, (char*)&c, 1);        offset = c << 8;        read(mfdn, (char*)&c, 1);        offset +=c;/* seek to socket base + pointer */        lseek(mfdn, (long) WZSKBASE,0);        lseek(mfdn, (long) offset, 1);/* read in device info */        if ( (i = read(mfdn, (char*)&wznwdev, sizeof(wznwdev)) ) !=                sizeof(wznwdev))        {                fprintf(stderr,"*** error reading device info!\n");                exit(2);        }/* fetched all, close file */        close (mfdn);        if (!t_opt)                exit(3);        if(t_opt == 1)        {            printf("\nTCP Sockets\n");            for (i = 0; i < 8; i++)             showsocket(i,&allsock[i], 1);        }        if(u_opt == 1)        {            printf("\nUDP Sockets\n");            for (i = 0; i < 8; i++)             showsocket(i,&allsock[i], 2);        }        if(r_opt == 1)        {            printf("\nIPRAW Sockets\n");            for (i = 0; i < 8; i++)             showsocket(i,&allsock[i], 4);        }}showsocket(cnt, sptr, flag)int cnt;struct WZSK *sptr;int flag;{int len, i;        if ((sptr->wzfsta & 0x80) == 0)                return;        switch(flag)        {            case 1:                if ((sptr->wztype & 0x00ff) != SOCK_STREAM)                        return;                printf("tcp    ");                if (sptr->wzipad == 0L)                {                     l2b.ll = sptr->wzipad;                     sprintf(formatbuf,"%d.%d.%d.%d:%u         ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzsprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     sprintf(formatbuf,"%d.%d.%d.%d:*          ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3]                     );                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     printf("%s\n",                       stat2str(sptr->wzstat) );                }                else                {                     l2b.ll = wznwdev.wzmyip;                     sprintf(formatbuf,"%d.%d.%d.%d:%u ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzsprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i <POS1 ; i++)                      printf(" ");                     l2b.ll = sptr->wzipad;                     sprintf(formatbuf,"%d.%d.%d.%d:%u ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzdprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     printf("%s\n",                       stat2str(sptr->wzstat) );                }                break;         case 2:               if ((sptr->wztype & 0x00ff) != SOCK_DGRAM)                        return;                printf("udp    ");                if (sptr->wzipad == 0L)                {                     l2b.ll = sptr->wzipad;                     sprintf(formatbuf,"%d.%d.%d.%d:%u         ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzsprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     sprintf(formatbuf,"%d.%d.%d.%d:*           ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzdprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     printf("%s\n",                       stat2str(sptr->wzstat) );                }                else                {                     l2b.ll = wznwdev.wzmyip;                     sprintf(formatbuf,"%d.%d.%d.%d:%u ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzsprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i <POS1 ; i++)                      printf(" ");                     l2b.ll = sptr->wzipad;                     sprintf(formatbuf,"%d.%d.%d.%d:%u ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzdprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     printf("%s\n",                       stat2str(sptr->wzstat) );                }                break;        case 4:                if ((sptr->wztype & 0x00ff) != SOCK_IPRAW)                        return;                printf("raw    ");                if (sptr->wzipad == 0L)                {                     l2b.ll = sptr->wzipad;                     sprintf(formatbuf,"%d.%d.%d.%d:%u         ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzsprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     sprintf(formatbuf,"%d.%d.%d.%d:*          ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3]                     );                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     printf("%s\n",                       stat2str(sptr->wzstat) );                }                else                {                     l2b.ll = wznwdev.wzmyip;                     sprintf(formatbuf,"%d.%d.%d.%d:%u ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzsprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i <POS1 ; i++)                      printf(" ");                     l2b.ll = sptr->wzipad;                     sprintf(formatbuf,"%d.%d.%d.%d:%u ",                     l2b.lc[0], l2b.lc[1],                     l2b.lc[2], l2b.lc[3],                     sptr->wzdprt);                     len = strlen(formatbuf);                     printf("%s", formatbuf);                     for(i = len; i < POS1 ; i++)                       printf(" ");                     printf("%s\n",                       stat2str(sptr->wzstat) );                }                break;        }}char *stat2str(stat_byte)char stat_byte;{        switch (stat_byte)        {            case S_SKCLS:                return ("CLOSED");                break;            case S_SINIT:                return ("INIT");                break;            case S_SLIST:                return ("LISTEN");                break;            case S_SESTB:                return ("ESTABLISHED");                break;            case S_CLSWT:                return ("CLOSE_WAIT");                break;            case S_SKUDP:                return ("UDP SOCKET");                break;            case S_SYNTX:                return ("SYN SENT");                break;            case S_SYNRX:                return ("SYN RECVD");                break;            case S_FINWT:                return ("FIN WAIT");                break;            case S_ISCLS:                return ("CLOSING");                break;            case S_TIMWT:                return ("TIME WAIT");                break;            case S_LSTAC:                return ("LAST ACK");                break;            case S_SIRAW:                return ("IP RAW");                break;            default:                return ("UNKNOWN");        }}