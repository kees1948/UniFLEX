#include <stdio.h>#include <net.h>#include <stat.h>#include <modes.h>#include <sgtty.h>#include <getopt.h>#include <signal.h>#include <errno.h>char buffer[512];#define PTYMAJOR 15 /* first test with fixed IP */#define MYSERVER "0.0.0.0"int abort();int pfdn, pid, tpid, sfdn;char *d_opt = NULL;char *p_opt = NULL;struct sgttyb serport;int main(argc, argv)int argc;char **argv;{    int  i=0, count =0, c;    struct sockaddr_in server;    uint16_t servlen;    struct stat statbuf;    while((c =getopt(argc, argv, "p:d:?")) != -1)    {        switch(c)        {            case 'p':                        p_opt = optarg;                        break;            case 'd':                        d_opt = optarg;                        break;            default:                        usage();        }    }    if((p_opt == NULL) || (d_opt == NULL))    {         usage();    }    tpid = getpid();    /* parent process */    if (stat(d_opt, (char*)&statbuf) != 0)    {        fprintf(stderr,"** Can't open pty %s\n", d_opt);        exit(-1);    }    /* check type of device */    if (!(statbuf.st_mode & S_IFCHR) || ((statbuf.st_size >>8) != PTYMAJOR) )    {        fprintf(stderr,"** %s is not pty device!\n", d_opt);        exit(-1);    }    signal(SIGPIPE, 1);    signal(SIGINT, 1);    while(1)    {        if((pid = fork()) == 0)        {  /* child */            signal(SIGPIPE, abort);            if((pfdn = open(d_opt, O_RDWR)) < 0)            {                if(errno == EBUSY) /* FATAL error, bail out completely */                {                    kill (tpid, 5);  /* kill parent first */                }                exit(1);             /* kill myself next */            }            if ((sfdn = socket(AF_INET, SOCK_STREAM|SOCK_NONBLOCK|SOCK_SIGPIPECLS, 0)) < 0)            {                exit(1);            }            bzero(&server, sizeof(struct server));            server.sin_family = AF_INET;            server.sin_port = atoi(p_opt);            server.sin_addr = (uint32_t) inet_addr(MYSERVER) ;            i = bind(sfdn,(struct sockaddr_in*) &server, sizeof(server));            if (i == -1)            {                exit(1);            }            listen(sfdn,1);            accept(sfdn,(struct sockaddr_in*) &server, &servlen);            while(1)            {                if((i = read (sfdn, buffer, 512)) > 0)                {                    if(i == 0)                    {                       close(sfdn);                       exit(0);                    }                    write (pfdn, buffer, i);                }                if((count = read (pfdn, buffer, 512)) > 0)                {                    write(sfdn, buffer, count);                }            } /* while */        }        else        { /*parent */             while(wait() != pid);             close (pfdn);             close (sfdn);        }     }   /* while */}int usage(){        fprintf(stderr,"rwserv2 -d <ptys_device> -p <port_number>\n");        exit(1);}int abort(){      close(pfdn);      close(sfdn);      exit(0);}