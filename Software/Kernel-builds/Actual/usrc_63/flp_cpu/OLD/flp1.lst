                               name   floppy1                                                    opt    lis,exp                               opt    nop                                    0AE9  FDC       set    2793                     *                                          * data inverse mask               0000  EOR4FDC   equ    0         00 = 2793, FF is 2791                                                               *                     * control latch out                     *               0009  LA_DS0    equ    %00001001 drive select 0               0010  LA_SID    equ    %00010000 side select               0020  LA_SDN    equ    %00100000 dens select 0=DD/1=SD               0040  LA_8_5    equ    %01000000 8"/5" data rate 0=8"/1=5"               0080  LA_HLT    equ    %10000000 toggle head load timer                     *                     * status buffer                     *               0040  ST_INT    equ    %01000000 interrupt from FDC               0040  ST_DRQ    equ    %1000000  data request from FDC                     *                     * FDC commands                     *               0000  FD_RST    equ    $00       restore               0010  FD_SEK    equ    $10       seek               0084  FD_SRD    equ    $84       read data               00A4  FD_SWR    equ    $A4       write data               0090  FD_MRD    equ    $90       read multiple               00B0  FD_MWR    equ    $B0       write multiple               00E0  FD_RTR    equ    $e0       read track               00F0  FD_WTR    equ    $F0       write track               00D0  FD_FIN    equ    $D0       force interrupt                     *                     * fdc hardware                     *               8000  fdcbas    equ    $8000                     * subject to EOR4FDC               0000  fo2cmd    equ    0         offset to command register               0001  fo2trk    equ    1         offset to track register               0002  fo2sec    equ    2         offset to sector register               0003  fo2dat    equ    3         offset to data register                     * not subject to EOR4FDC               0004  fo4lat    equ    4         drive,side,density latch               0008  fo4sta    equ    8         fdc status                                    0009  dprdrv    equ    9               000B  dprsid    equ    11               000C  dprdns    equ    12                                          *               000C  fo2trg    equ    12        scope trigger                                          *        org     $0800  0020                         org    $0020  0020               buffer1   rmb    512                     *buffer1 rmb     1024            max sector size                     *buffer2 rmb     1024                     *  0220               side      rmb    1  0221 01            dens      fcb    1  0222               track     rmb    1  0223               sector    rmb    1  0224               latch     rmb    1  0225               lside     rmb    1                     *  0226 41AA          wrkprm    fdb    fltabl                     *  0228 00            step      rzb    1  0229 04            retry     fcb    4  022A               bf1ptr    rmb    2  022C               bf1siz    rmb    2  022E               bf2ptr    rmb    2  0230               bf2siz    rmb    2                       4000                         org    $4000                                                                                                   4000  start     equ    *  4000 1A   50                 orcc   #$50  4002 B6   03FF               lda    $03ff  4005 1027 00BD               lbeq   loop                     *  4009 86   04                 lda    #4  400B B7   0229               sta    retry  400E 86   09                 lda    #LA_DS0  4010 B7   8004               sta    fdcbas+fo4lat  4013 B7   0224               sta    latch                                            4016 108E 7FFF               ldy    #$7fff  401A 34   20                 pshs   y  401C B6   8000     21        lda    fdcbas+fo2cmd  401F 2A   15                 bpl    22f       ready  4021 B6   0224               lda    latch  4024 B7   8004               sta    fdcbas+fo4lat  4027 31   3F                 leay   -1,y  4029 26   F1                 bne    21b  402B 6A   E4                 dec    0,s  402D 26   ED                 bne    21b  402F 35   20                 puls   y                     *  4031 86   81                 lda    #$81  4033 7E   40B6               jmp    08f                       4036 35   20       22        puls   y  4038 96   0F                 lda    $000f                     ***     beq     24f                     *                     *       clr     $000f  403A 86   00       47        lda    #FD_RST   restore  403C 88   00                 eora   #EOR4FDC  403E B7   8000               sta    fdcbas+fo2cmd  4041 BD   40D0               jsr    dlytim  4044 B6   8000     01        lda    fdcbas+fo2cmd  4047 85   01                 bita   #%00000001  4049 26   F9                 bne    01b  404B 7F   8001               clr    fdcbas+fo2trk  404E 7F   0222               clr    track                     *  4051 C6   01       24        ldb    #1  4053 F7   0228               stb    step                       4056 0F   08       07        clr    $0008  4058 B6   0224               lda    latch  405B B7   8004               sta    fdcbas+fo4lat  405E 108E C350               ldy    #50000  4062 B6   8000     21        lda    fdcbas+fo2cmd  4065 2A   09                 bpl    20f       ready  4067 31   3F                 leay   -1,y  4069 26   F7                 bne    21b  406B 86   81                 lda    #$81 >406D 7E   40B6               jmp    08f                       4070 BE   0226     20        ldx    wrkprm  4073 EC   84                 ldd    0,x  4075 1093 10                 cmpd   $0010                     **      beq     30f  4078 BD   418F               jsr    srchpm  407B 1F   12                 tfr    x,y                     *       bra     20b                       407D C6   02       30        ldb    #2  407F F7   0228               stb    step  4082 BD   4116               jsr    clcpos    block -> track/sector  4085 26   2F                 bne    08f                       4087 8E   8000               ldx    #fdcbas  408A C6   03                 ldb    #3  408C F7   0228               stb    step  408F BD   415F               jsr    fseek  4092 26   22                 bne    08f                       4094 CE   0020               ldu    #buffer1  4097 8E   8000               ldx    #fdcbas  409A C6   04                 ldb    #4  409C F7   0228               stb    step >409F BD   40D9               jsr    frdsec  40A2 97   08                 sta    $0008  40A4 27   10                 beq    08f  40A6 81   90                 cmpa   #%10010000  40A8 26   07                 bne    15f  40AA 7A   0229               dec    retry  40AD 2A   8B                 bpl    47b  40AF 20   05                 bra    08f  40B1 7A   0229     15        dec    retry  40B4 2A   A0                 bpl    07b                                          *  40B6 97   08       08        sta    $0008     status  40B8 C6   05                 ldb    #5  40BA F7   0228               stb    step  40BD 12                      nop                       40BE 7F   03FF               clr    $03ff     remove request  40C1 86   FF                 lda    #$ff      tell CPU we did it  40C3 B7   03FE               sta    $03fe                     *  40C6 12            loop      nop  40C7 7D   03FD               tst    $03fd  40CA 27   01                 beq    04f                       40CC 3F            10        swi  40CD 7E   4000     04        jmp    start                                            40D0 8D   00       dlytim    bsr    dly1  40D2 8D   00       dly1      bsr    dly2  40D4 8D   00       dly2      bsr    dly3  40D6 1E   11       dly3      exg    x,x  40D8 39                      rts                                                               *                     * code routine, to read one sector from FDC                     * U holds buffer address, count from data address mark                     * drive select, density and such alreay set up                     * time out from INT fdc                     *               40D9  frdsec    equ    *  40D9 34   71                 pshs   cc,x,y,u                     *  40DB 86   84                 lda    #FD_SRD   start read operation  40DD 88   00                 eora   #EOR4FDC  40DF A7   84                 sta    fo2cmd,x >40E1 BD   40D0               jsr    dlytim                     *  40E4 1A   50       01        orcc   #$50      disable ints  40E6 20   06                 bra    03f                       40E8 A6   03       02        lda    fo2dat,x  get data  40EA 88   00                 eora   #EOR4FDC  40EC A7   C0                 sta    0,u+                       40EE A6   84       03        lda    fo2cmd,x  follow next  40F0 88   00                 eora   #EOR4FDC  40F2 85   02                 bita   #2  40F4 26   F2                 bne    02b  40F6 85   01                 bita   #1  40F8 26   F4                 bne    03b                     *  40FA 10AE 65       98        ldy    5,s  40FD                         subr   Y,U       get count  40FD 1032                    fdb    $1032  40FF 23                      fcb    Y<<4|U                               endm  4100 DF   1E                 stu    $001e  4102 1183 0200               cmpu   #512  4106 27   04                 beq    97f  4108 86   10                 lda    #%00010000 rnf  410A 20   06                 bra    96f       count in X  410C A6   84       97        lda    fo2cmd,x  read status  410E 84   98                 anda   #%10011000  4110 27   02                 beq    99f  4112 8A   80       96        ora    #$80  4114 35   F1       99        puls   cc,x,y,u,pc                                          *                     * clcpos, transfer block# into track/sector/side                     *               4116  clcpos    equ    *  4116 10BE 0226               ldy    wrkprm  411A 7F   0225               clr    lside  411D DC   02                 ldd    $0002     block no  411F 6F   E2                 clr    0,-s  4121               02  4121 A3   23                 subd   3,y       sectrk  4123 25   04                 blo    01f  4125 6C   E4                 inc    0,s       up track #  4127 20   F8                 bra    02b  4129 E3   23       01        addd   3,y                     * sec in B,track# on stack  412B 34   04                 pshs   b  412D E6   21                 ldb    1,y       is double side?  412F C4   01                 andb   #%00000001  4131 35   04                 puls   b  4133 27   15                 beq    05f       no                     *  4135 64   E4                 lsr    0,s       track#  4137 24   11                 bcc    05f       even track                     * odd track, add bias  4139 7C   0225               inc    lside  413C E3   23                 addd   3,y  413E 34   04                 pshs   b  4140 F6   0224               ldb    latch  4143 CA   10                 orb    #LA_SID   select side 1  4145 F7   0224               stb    latch  4148 35   04                 puls   b                     *  414A 5C            05        incb             1 relative  414B F7   0223     03        stb    sector                     *  414E 35   02                 puls   a  4150 B7   0222               sta    track  4153 A1   22                 cmpa   2,y  4155 22   05                 bhi    91f  4157 4F                      clra  4158 39                      rts                       4159 86   81       90        lda    #%10000001  415B 39                      rts                       415C 86   80       91        lda    #%10000000  415E 39                      rts                                                               *                     *                     * fseek,                     *               415F  fseek     equ    *  415F 34   70                 pshs   x,y,u  4161 B6   0224               lda    latch  4164 A7   04                 sta    fo4lat,x  4166 B6   0223               lda    sector  4169 A7   02                 sta    fo2sec,x                       416B B6   0222               lda    track  416E A1   01                 cmpa   fo2trk,x  4170 27   15                 beq    80f                     *  4172 A7   03                 sta    fo2dat,x  4174 86   10                 lda    #FD_SEK  4176 A7   84                 sta    fo2cmd,x  4178 BD   40D0               jsr    dlytim                     *       ldy     #50000  417B A6   84       01        lda    fo2cmd,x  417D 85   01                 bita   #1  417F 27   06                 beq    80f                     *       leay    -1,y                     *       bne     01b  4181 20   F8                 bra    01b  4183 86   81                 lda    #$81  4185 20   06                 bra    02f                       4187 B6   0224     80        lda    latch  418A A7   04                 sta    fo4lat,x  418C 4F                      clra                       418D 35   F0       02        puls   x,y,u,pc                                    418F  srchpm    equ    *  418F 8E   41AA               ldx    #fltabl  4192 DC   0B       03        ldd    $000B  4194 84   40                 anda   #%01000000 side bits  4196 C4   C1                 andb   #%11000001 dens bits  4198 10A3 84                 cmpd   0,x       fltsid  419B 27   09                 beq    01f  419D 30   06                 leax   6,x  419F 6D   02                 tst    2,x  41A1 26   EF                 bne    03b  41A3 8E   41AA               ldx    #flpdfl                       41A6 BF   0226     01        stx    wrkprm  41A9 39                      rts                                    41AA  fltabl    equ    *  41AA 00 00 4C 00   flpdfl    fcb    $00,$00,76,0,8,0 FD-XS  41B0 00 01 4C 00             fcb    $00,$01,76,0,16,0 FD-DX  41B6 40 00 4F 00             fcb    $40,$00,79,0,5,0 F5-SX  41BC 40 01 4F 00             fcb    $40,$01,79,0,9,0 F5-XD  41C2 40 41 4F 00             fcb    $40,$41,79,0,10,0 F5-XDE  41C8 00 81 4F 00             fcb    $00,$81,79,0,18,0 F3-XD  41CE 00 C1 4F 00             fcb    $00,$c1,79,0,20,0 F3-XH  41D4 00 00 00 00             fcb    0,0,0,0,0,00 Error(s) detected     3 Excessive BRANCH/JUMP(S) detectedSymbol Table:Absolute Symbols:A        0008   B        0009   CC       000A   D        0000   DP       000B   E        000E   EOR4FDC  0000   F        000F   FDC      0AE9   FD_FIN   00D0   FD_MRD   0090   FD_MWR   00B0   FD_RST   0000   FD_RTR   00E0   FD_SEK   0010   FD_SRD   0084   FD_SWR   00A4   FD_WTR   00F0   FF       0040   IF       0010   LA_8_5   0040   LA_DS0   0009   LA_HLT   0080   LA_SDN   0020   LA_SID   0010   PC       0005   S        0004   ST_DRQ   0040   ST_INT   0040   U        0003   V        0007   W        0006   X        0001   Y        0002   bf1ptr   022A   bf1siz   022C   bf2ptr   022E   bf2siz   0230   buffer1  0020   clcpos   4116   dens     0221   dly1     40D2   dly2     40D4   dly3     40D6   dlytim   40D0   dprdns   000C   dprdrv   0009   dprsid   000B   fdcbas   8000   flpdfl   41AA   fltabl   41AA   fo2cmd   0000   fo2dat   0003   fo2sec   0002   fo2trg   000C   fo2trk   0001   fo4lat   0004   fo4sta   0008   frdsec   40D9   fseek    415F   latch    0224   loop     40C6   lside    0225   retry    0229   sector   0223   side     0220   srchpm   418F   start    4000   step     0228   track    0222   wrkprm   0226   