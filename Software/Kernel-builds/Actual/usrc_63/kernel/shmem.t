                lib     ./environment.h                data                global  ummap                if      (SHMEM=1)** ummap  flag, prmemad* return reffd** virtpag may be 1 up to 8 (12) or 0*ummap           equ     *                ldx     shminf                beq     02f             bad argument                ldu     usarg0          check flag                bmi     02f*05              lda     shmcnt,x        allocated?                beq     03f                cmpu    shmkey,x        same key                bne     04f                ldd     uuid                cmpd    shmuid,x        same user?                bne     04f* share                lda     usarg1          where to map                cmpa    #$f0                bhs     02f                bra     09f* error02              lda     #EBARG                sta     uerror                rts* allocated04              ldx     0,x             follow link                beq     02b                bra     05b* free, allocate03              lda     usarg1          process memory                cmpa    #$f0                bhs     02b             invalid*                stu     shmkey,x        allocate                ldy     uuid                sty     shmuid,x* zero it out                pshs    d                lda     shmpag,x        THIS page                jsr     clrpga          erase it                puls    d* set process mempry page09              lsra                lsra                lsra                lsra                ldu     #umem                ldb     a,u                cmpb    BLKHOL                beq     08f                cmpb    #NONRAM         exclude shared pages                bhs     08f                jsr     givpag          return this page first08              ldb     shmpag,x                stb     a,u             put page in memtab                tst     MAXMAP          extended mapper                beq     10f                inc     urelod          trigger mapper update10              inc     shmcnt,x                rts                end