          sttl    FIO        Simulation Routines          pag** fio_msg - Send a message via the FIO Mailbox* it is assumed that the FIO (DPR) sits at $0000*   B - Message code to send (one byte)*   fio_cpu1..3 already set up*fio_msg   pshs    b,x,u      save register          ldu     fio_dsz          leau    -2,u       one off top          stb     fio_cpu    set up mailbox value5         lda     #$FF       tell CPU mailbox full          sta     0,u        fio_cpuF05        ldx     #$FFFF     time-out counter*10        lda     0,u        fio_cpuF   wait till value consumed          beq     20f        jump if consumed*          leax    -1,x       time-out yet?          bne     10b*          bra     05b        try again*20        puls    b,x,u,pc*** fio_response - Return a response code/sequence #* it is assumed that the FIO (DPR) sits at $0000*    X = utask,*    B - Response code*    A - Transaction specific value*fio_response pshs    d,x          bsr     FIO_get    access FIO          ldx     utask      task ID          ldd     tsseq,x          std     fio_cpu1          ldd     tsdev,x    device info          std     fio_cpu3          lda     0,s        get transaction specific value          sta     fio_cpu2          ldb     1,s        is RESPONSE code          jsr     fio_msg          bsr     FIO_rel    release FIO          puls    d,x,pc     return** FIO_get - Get access to FIO device* -- Sleep till available*FIO_get   pshs    d,x,y,u    save registers10        ldy     #FIO_lock  is the device locked          tst     0,y          beq     20f        no - go get it*          ldb     #FIOPRI    waiting for the FIO          jsr     sleep          bra     10b        try again*20        inc     0,y        mark in use          puls    d,x,y,u,pc return** FIO_rel - Release access to FIO*FIO_rel   pshs    d,x,y,u          ldy     #FIO_lock          clr     0,y          jsr     wakeup          puls    d,x,y,u,pc return** FIFO_get - Fetch character from FIFO*   B - Character fetched*FIFOgeta  pshs    b          bsr     FIFO_get          puls    a          exg     a,b          rts*FIFO_get  pshs    a,x          ldd     fifo_cnt   any data?          beq     99f        no - exit*          decd    yes        - adjust count          std     fifo_cnt          ldx     fifo_get   get consumer pointer          ldb     fifo,x     fetch byte          leax    1,x        bump pointer          cmpx    fio_fsz    end of fifo?          bne     10f*          ldx     #0         reset pointer*10        stx     fifo_get*99        puls    a,x,pc** FIFO_put - Place character into FIFO*   B - Character fetched*FIFOputa  pshs    b          tfr     a,b          bsr     FIFO_put          puls    b,pc*FIFO_put  pshs    d,x          ldx     fifo_put   get consumer pointer          stb     fifo,x     store byte          leax    1,x        bump pointer          cmpx    fio_fsz    end of FIFO?          bne     10f*          ldx     #0         reset pointer10        stx     fifo_put*          ldd     fifo_cnt          incd          std     fifo_cnt99        puls    d,x,pc